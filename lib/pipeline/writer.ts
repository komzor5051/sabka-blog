import { generatePro } from "@/lib/gemini";
import { Source } from "@/lib/researcher";
import { SABKA_STYLE_GUIDE } from "./style-guide";

interface WriterInput {
  title: string;
  angle: string;
  keywords: string[];
  sources: Source[];
}

export async function writeArticle(input: WriterInput): Promise<string> {
  const sourcesContext = input.sources
    .map((s) => `[${s.title}](${s.url}): ${s.summary}`)
    .join("\n\n");

  const today = new Date().toLocaleDateString("ru-RU", {
    year: "numeric", month: "long", day: "numeric",
  });

  const prompt = `Ты автор блога SaaS-сервиса "Сабка" (sabka.pro) — мультичат для работы с ChatGPT, Claude, Gemini, DeepSeek без VPN.

Дата: ${today}

Напиши статью на тему: "${input.title}"
Угол раскрытия: ${input.angle}
SEO-ключевые слова (встрой естественно): ${input.keywords.join(", ")}

Источники для фактов и ссылок:
${sourcesContext}

${SABKA_STYLE_GUIDE}

СТРУКТУРА ЗАГОЛОВКОВ (СТРОГО):
- Заголовок статьи НЕ НУЖЕН (он будет добавлен отдельно как H1)
- Используй ## (H2) для основных секций
- Используй ### (H3) для подсекций внутри H2
- НИКОГДА не пропускай уровни (нет H3 без родительского H2)
- Каждый H2 должен быть информативным, содержать ключевое слово

КАРТИНКИ-МЕМЫ (ОБЯЗАТЕЛЬНО):
Вставляй 4-6 мемных картинок по всей статье в формате:
![MEME: описание картинки на русском](placeholder)

Правила для картинок:
- Первая картинка — сразу после первого абзаца (будет cover image)
- Остальные — через каждые 2-3 секции
- Описание должно быть КОНКРЕТНЫМ: кто, что делает, какой текст на картинке
- Текст на картинке — на РУССКОМ, короткий (5-10 слов), мемный
- Стиль: смешные ситуации из мира AI/технологий, понятные целевой аудитории
- Примеры хороших описаний:
  * "Программист в 3 часа ночи перед монитором с 20 вкладками AI чатов, подпись КОГДА CHATGPT ДАЕТ РАЗНЫЙ ОТВЕТ КАЖДЫЙ РАЗ"
  * "Собака в костюме профессора объясняет формулы на доске, подпись НЕЙРОСЕТЬ ОБЪЯСНЯЕТ КВАНТОВУЮ ФИЗИКУ"
  * "Два рыцаря сражаются на мечах, на щитах надписи CLAUDE и CHATGPT, подпись БИТВА ЗА ЛУЧШИЙ ОТВЕТ"

Требования:
- 1500-2500 слов
- Формат Markdown
- Ссылки на источники в тексте
- В секции "Как это сделать в Сабке" — конкретный пример использования мультичата или промптов
- Заверши CTA: "Попробуйте бесплатно в Сабке" со ссылкой https://sabka.pro?utm_source=blog

Напиши ТОЛЬКО статью в Markdown, без вступления от себя.`;

  return generatePro(prompt);
}
