import { generatePro } from "@/lib/gemini";
import { Source } from "@/lib/researcher";
import { supabase } from "@/lib/supabase";
import { SABKA_STYLE_GUIDE } from "./style-guide";
import { SABKA_FEATURES } from "@/lib/sabka-features";

interface WriterInput {
  title: string;
  angle: string;
  keywords: string[];
  sources: Source[];
}

async function getExistingArticles(): Promise<string> {
  const { data } = await supabase
    .from("blog_posts")
    .select("title, slug")
    .eq("status", "published")
    .order("published_at", { ascending: false })
    .limit(30);

  if (!data || data.length === 0) return "";

  return data
    .map((p) => `- [${p.title}](/blog/${p.slug})`)
    .join("\n");
}

export async function writeArticle(input: WriterInput): Promise<string> {
  const sourcesContext = input.sources
    .map((s) => `[${s.title}](${s.url}): ${s.summary}`)
    .join("\n\n");

  const existingArticles = await getExistingArticles();

  const today = new Date().toLocaleDateString("ru-RU", {
    year: "numeric", month: "long", day: "numeric",
  });

  const internalLinksBlock = existingArticles
    ? `\nВНУТРЕННИЕ ССЫЛКИ (ОБЯЗАТЕЛЬНО):
Вот список уже опубликованных статей в нашем блоге:
${existingArticles}

Правила внутренней перелинковки:
- Вставь 2-4 ссылки на релевантные статьи из списка выше ЕСТЕСТВЕННО по тексту
- Ссылки должны быть органичными: "как мы писали в статье [название](url)" или "подробнее об этом — в [название](url)"
- НЕ ссылайся на статью, если она не связана с темой
- НЕ вставляй все ссылки в одно место — распредели по тексту
- Используй ТОЧНЫЕ URL из списка, не выдумывай\n`
    : "";

  const prompt = `Ты автор блога "Сабка" (sabka.pro). Пишешь живым русским языком, как реальный человек.

Дата: ${today}

Напиши статью на тему: "${input.title}"
Угол раскрытия: ${input.angle}
SEO-ключевые слова (встрой естественно): ${input.keywords.join(", ")}

Источники для фактов и ссылок:
${sourcesContext}

${SABKA_STYLE_GUIDE}

РЕАЛЬНЫЕ ФУНКЦИИ САБКИ (используй ТОЛЬКО эту информацию, НЕ выдумывай фичи):
${SABKA_FEATURES}

СТРУКТУРА ЗАГОЛОВКОВ (СТРОГО):
- Заголовок статьи НЕ НУЖЕН (он будет добавлен отдельно как H1)
- Используй ## (H2) для основных секций
- Используй ### (H3) для подсекций внутри H2
- НИКОГДА не пропускай уровни (нет H3 без родительского H2)
- Каждый H2 должен быть информативным, содержать ключевое слово
${internalLinksBlock}
КАРТИНКИ-МЕМЫ (ОБЯЗАТЕЛЬНО):
Вставляй 2-3 мемных картинки по всей статье в формате:
![MEME: описание картинки на русском](placeholder)

Правила для картинок:
- Первая картинка — сразу после первого абзаца (будет cover image)
- Вторая — примерно в середине статьи
- Третья (если есть) — ближе к концу, перед CTA
- Описание должно быть КОНКРЕТНЫМ: кто, что делает, какой текст на картинке
- Текст на картинке — на РУССКОМ, короткий (5-10 слов), мемный
- Стиль: смешные ситуации из мира нейросетей, понятные целевой аудитории
- НЕ БОЛЬШЕ 3 картинок!

ПРОМПТЫ И КОМАНДЫ (ВАЖНО):
- Когда приводишь примеры промптов, команд или текстов для копирования — оформляй их в блоках кода (тройные бэктики \`\`\`)
- НЕ используй инлайн-код (одинарные бэктики) для длинных промптов
- Пример правильного оформления:
  \`\`\`
  Напиши маркетинговый текст для продукта [название], целевая аудитория — [описание]
  \`\`\`

ОБЯЗАТЕЛЬНЫЕ ССЫЛКИ:
- Минимум 1 ссылка на библиотеку промптов: [библиотека промптов Сабки](https://sabka.pro/prompts) — вставь естественно, когда речь о промптах
- Ссылки на https://sabka.pro в контексте (когда упоминаешь Сабку по делу, не спамь)
- Если статья про бизнес/работу — добавь ссылку на https://sabka.pro/business

СТРУКТУРА СТАТЬИ:
1. Хук — 1-2 цепляющих предложения (проблема, вопрос, провокация)
2. Краткий пересказ — сразу после хука напиши 2-3 предложения "В этой статье: ..." чтобы человек понял, стоит ли читать
3. Основная часть — пошагово, с примерами и промптами
4. Секция "Как это сделать в Сабке" — конкретный пример с реальными фичами (мультичат, фактчек, память, промпты)
5. Напоминание про тарифы — перед CTA вставь абзац: Сабка — не безлимитный сервис, разные модели стоят по-разному. GPT 5 жрёт токены быстрее, DeepSeek Chat — экономнее. Бесплатно — 12 запросов, Plus за 999 руб/мес — 4 млн токенов.
6. CTA: "Попробуйте бесплатно в Сабке" со ссылкой https://sabka.pro?utm_source=blog

Требования:
- 1500-2500 слов
- Формат Markdown
- Ссылки на источники в тексте
- Язык — простой, живой, разговорный. Объясняй на пальцах, без задротства.
- Пиши "ИИ", не "AI". Пиши "ВИПИЭН", не "VPN" (кроме фразы "без VPN" про Сабку).

Напиши ТОЛЬКО статью в Markdown, без вступления от себя.`;

  return generatePro(prompt);
}
