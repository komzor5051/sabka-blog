import { generatePro } from "@/lib/gemini";
import { Source } from "@/lib/researcher";
import { supabase } from "@/lib/supabase";
import { SABKA_STYLE_GUIDE } from "./style-guide";

interface WriterInput {
  title: string;
  angle: string;
  keywords: string[];
  sources: Source[];
}

async function getExistingArticles(): Promise<string> {
  const { data } = await supabase
    .from("blog_posts")
    .select("title, slug")
    .eq("status", "published")
    .order("published_at", { ascending: false })
    .limit(30);

  if (!data || data.length === 0) return "";

  return data
    .map((p) => `- [${p.title}](/blog/${p.slug})`)
    .join("\n");
}

export async function writeArticle(input: WriterInput): Promise<string> {
  const sourcesContext = input.sources
    .map((s) => `[${s.title}](${s.url}): ${s.summary}`)
    .join("\n\n");

  const existingArticles = await getExistingArticles();

  const today = new Date().toLocaleDateString("ru-RU", {
    year: "numeric", month: "long", day: "numeric",
  });

  const internalLinksBlock = existingArticles
    ? `\nВНУТРЕННИЕ ССЫЛКИ (ОБЯЗАТЕЛЬНО):
Вот список уже опубликованных статей в нашем блоге:
${existingArticles}

Правила внутренней перелинковки:
- Вставь 2-4 ссылки на релевантные статьи из списка выше ЕСТЕСТВЕННО по тексту
- Ссылки должны быть органичными: "как мы писали в статье [название](url)" или "подробнее об этом — в [название](url)"
- НЕ ссылайся на статью, если она не связана с темой
- НЕ вставляй все ссылки в одно место — распредели по тексту
- Используй ТОЧНЫЕ URL из списка, не выдумывай\n`
    : "";

  const prompt = `Ты автор блога SaaS-сервиса "Сабка" (sabka.pro) — мультичат для работы с ChatGPT, Claude, Gemini, DeepSeek без VPN.

Дата: ${today}

Напиши статью на тему: "${input.title}"
Угол раскрытия: ${input.angle}
SEO-ключевые слова (встрой естественно): ${input.keywords.join(", ")}

Источники для фактов и ссылок:
${sourcesContext}

${SABKA_STYLE_GUIDE}

СТРУКТУРА ЗАГОЛОВКОВ (СТРОГО):
- Заголовок статьи НЕ НУЖЕН (он будет добавлен отдельно как H1)
- Используй ## (H2) для основных секций
- Используй ### (H3) для подсекций внутри H2
- НИКОГДА не пропускай уровни (нет H3 без родительского H2)
- Каждый H2 должен быть информативным, содержать ключевое слово
${internalLinksBlock}
КАРТИНКИ-МЕМЫ (ОБЯЗАТЕЛЬНО):
Вставляй 4-6 мемных картинок по всей статье в формате:
![MEME: описание картинки на русском](placeholder)

Правила для картинок:
- Первая картинка — сразу после первого абзаца (будет cover image)
- Остальные — через каждые 2-3 секции
- Описание должно быть КОНКРЕТНЫМ: кто, что делает, какой текст на картинке
- Текст на картинке — на РУССКОМ, короткий (5-10 слов), мемный
- Стиль: смешные ситуации из мира AI/технологий, понятные целевой аудитории
- Примеры хороших описаний:
  * "Программист в 3 часа ночи перед монитором с 20 вкладками AI чатов, подпись КОГДА CHATGPT ДАЕТ РАЗНЫЙ ОТВЕТ КАЖДЫЙ РАЗ"
  * "Собака в костюме профессора объясняет формулы на доске, подпись НЕЙРОСЕТЬ ОБЪЯСНЯЕТ КВАНТОВУЮ ФИЗИКУ"
  * "Два рыцаря сражаются на мечах, на щитах надписи CLAUDE и CHATGPT, подпись БИТВА ЗА ЛУЧШИЙ ОТВЕТ"

ПРОМПТЫ И КОМАНДЫ (ВАЖНО):
- Когда приводишь примеры промптов, команд или текстов для копирования — оформляй их в блоках кода (тройные бэктики \`\`\`)
- НЕ используй инлайн-код (одинарные бэктики) для длинных промптов
- Пример правильного оформления:
  \`\`\`
  Напиши маркетинговый текст для продукта [название], целевая аудитория — [описание]
  \`\`\`

Требования:
- 1500-2500 слов
- Формат Markdown
- Ссылки на источники в тексте
- В секции "Как это сделать в Сабке" — конкретный пример использования мультичата или промптов
- Заверши CTA: "Попробуйте бесплатно в Сабке" со ссылкой https://sabka.pro?utm_source=blog

Напиши ТОЛЬКО статью в Markdown, без вступления от себя.`;

  return generatePro(prompt);
}
